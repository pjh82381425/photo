<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="{{ url_for('static', filename='function.js') }}"></script>

<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PHOTOISM</title>
</head>

<body>
    <div class="kiosk">
        <section class="hero">

            <div id="grid" class="grid">
                {% for f in files %}
                <div class="item" data-id="{{ loop.index }}">
                    <img src="/{{ folder_rel }}/{{ f }}" alt="capture {{ loop.index }}">
                </div>
                {% endfor %}
            </div>

            <div class="logo">
                <button class="select" id="selectBtn">
                    <span class="label">ì„ íƒ ì™„ë£Œ</span>
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none">
                        <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
                <div class="hint">ì‚¬ì§„ 4ì¥ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            </div>

        </section>
    </div>
</body>

</html>

<style>
    .item.selected {
        border: 3px solid #10B981;
        border-radius: 10px;
    }

    html,
    body,
    .kiosk {
        height: 100%;
    }

    body {
        overflow: auto;
    }

    #grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
        padding: 12px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .item img {
        width: 100%;
        height: 180px;
        object-fit: cover;
        display: block;
        border-radius: 10px;
        border: 2px solid #e5e7eb;
        /* slate-200 */
    }

    .photo-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }

    .photo-thumb {
        border: 2px solid transparent;
        cursor: pointer;
    }

    .photo-thumb.selected {
        border-color: red;
    }

    .select {
        margin-top: 24px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const selectBtn = document.getElementById('selectBtn');
        const selected = new Set(); // ì„ íƒëœ ì‚¬ì§„ id ì €ì¥
        const grid = document.getElementById('grid');
        const photoBtn = document.getElementById('photoBtn');
        const photoList = document.getElementById('photoList');

        if (selectBtn) {
            let isNavigating = false;
            selectBtn.addEventListener('click', e => {
                if (isNavigating) return;
                isNavigating = true;
                e.preventDefault();

                document.body.classList.remove('loaded');
                document.body.getBoundingClientRect();
                document.body.classList.add('fade-out');

                const go = () => window.location.href = '/edit';
                const onEnd = ev => {
                    if (ev.target === document.body && ev.propertyName === 'opacity') {
                        document.body.removeEventListener('transitionend', onEnd);
                        go();
                    }
                };
                document.body.addEventListener('transitionend', onEnd);
            });
        }

        // ğŸ“Œ ê¸°ì¡´ ì‚¬ì§„ ì„ íƒ toggle
        if (grid) {
            grid.querySelectorAll('.item').forEach(el => {
                const id = parseInt(el.dataset.id);
                el.addEventListener('click', () => toggleSelect(el, id));
            });
        }

        // ğŸ“Œ ìƒˆë¡œìš´ ì‚¬ì§„ ì´¬ì˜ í›„ ëª©ë¡ì— ì¶”ê°€
        photoBtn?.addEventListener('click', async (e) => {
            e.preventDefault();
            if (photoBtn.disabled) return;
            photoBtn.disabled = true;

            try {
                const r = await fetch('/capture', { method: 'GET', cache: 'no-store' });
                const t = await r.text();
                if (t.trim().startsWith('cap')) {
                    const id = parseInt(t.match(/\d+/)[0]);
                    addPhotoToList(id);
                }
                if (t.trim() === 'done') triggerResultTransition();
            } catch (e) {
                console.error(e);
            } finally {
                photoBtn.disabled = false;
            }
        });

        // ğŸ“Œ ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” ì¸ë„¤ì¼ì— ëŒ€í•´ toggle ë“±ë¡
        function addPhotoToList(id) {
            const div = document.createElement('div');
            div.className = 'photo-thumb';
            div.dataset.id = id;
            div.innerHTML = `<img src="/static/capture${id}.jpg" alt="ì‚¬ì§„ ${id}" width="120" height="90">`;
            div.addEventListener('click', () => toggleSelect(div, id));
            photoList.appendChild(div);
        }

        // âœ… ê³µí†µ ì„ íƒ toggle í•¨ìˆ˜: ì„ íƒ/ì„ íƒì·¨ì†Œ + ì„œë²„ ìš”ì²­ + í´ë˜ìŠ¤ ì²˜ë¦¬
        function toggleSelect(el, id) {
            const isSelected = selected.has(id);

            // ì„ íƒ ì¶”ê°€í•˜ë ¤ëŠ”ë° ì´ë¯¸ 4ê°œë©´ ë§‰ê¸°
            if (!isSelected && selected.size >= 4) {
                alert('ì‚¬ì§„ì€ ìµœëŒ€ 4ì¥ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }

            const url = isSelected ? `/delete/${id}` : `/select/${id}`;
            fetch(url, { method: 'POST' }).then(r => {
                if (r.ok) {
                    if (isSelected) {
                        selected.delete(id);
                        el.classList.remove('selected');
                    } else {
                        selected.add(id);
                        el.classList.add('selected');
                    }
                }
            });
        }
    });
</script>