<link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
<script src="{{ url_for('static', filename='function.js') }}"></script>

<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PHOTOISM</title>
</head>

<body>
    <div class="kiosk" role="application" aria-label="Ìè¨ÌÜ†Ïù¥Ï¶ò ÌÇ§Ïò§Ïä§ÌÅ¨ Ï≤´ ÌôîÎ©¥">
        <section class="hero" aria-labelledby="hero-title">
            <div id="grid" class="grid">
                {% for f in files %}
                <button type="button" class="item" data-id="{{ loop.index }}">
                    <img src="/{{ folder_rel }}/{{ f }}" alt="capture {{ loop.index }}">
                </button>
                {% endfor %}
            </div>
            <section class="photo-list" id="photoList"></section>
            <div class="logo">
                <button class="select" id="selectBtn" aria-label="ÏÑ†ÌÉùÏôÑÎ£å">
                    <span class="label">ÏÑ†ÌÉùÏôÑÎ£å</span>
                    <svg class="arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M5 12h14M13 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </button>
            </div>
        </section>
    </div>
</body>

</html>

<style>
    .item.selected {
        border: 3px solid #10B981;
        border-radius: 10px;
    }

    html,
    body,
    .kiosk {
        height: 100%;
    }

    body {
        overflow: auto;
    }

    #grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 12px;
        padding: 12px;
        max-height: 70vh;
        overflow-y: auto;
    }

    .item img {
        width: 100%;
        height: 140px;
        object-fit: cover;
        display: block;
    }

    .photo-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
    }

    .photo-thumb {
        border: 2px solid transparent;
        cursor: pointer;
    }

    .photo-thumb.selected {
        border-color: red;
    }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const selectBtn = document.getElementById('selectBtn');
    const selected = new Set(); // ÏÑ†ÌÉùÎêú ÏÇ¨ÏßÑ id Ï†ÄÏû•
    const grid = document.getElementById('grid');
    const photoBtn = document.getElementById('photoBtn');
    const photoList = document.getElementById('photoList');

    if (selectBtn) {
      let isNavigating = false;
      selectBtn.addEventListener('click', e => {
        if (isNavigating) return;
        isNavigating = true;
        e.preventDefault();

        document.body.classList.remove('loaded');
        document.body.getBoundingClientRect();
        document.body.classList.add('fade-out');

        const go = () => window.location.href = '/edit';
        const onEnd = ev => {
          if (ev.target === document.body && ev.propertyName === 'opacity') {
            document.body.removeEventListener('transitionend', onEnd);
            go();
          }
        };
        document.body.addEventListener('transitionend', onEnd);
      });
    }

    // üìå Í∏∞Ï°¥ ÏÇ¨ÏßÑ ÏÑ†ÌÉù toggle
    if (grid) {
      grid.querySelectorAll('.item').forEach(el => {
        const id = parseInt(el.dataset.id);
        el.addEventListener('click', () => toggleSelect(el, id));
      });
    }

    // üìå ÏÉàÎ°úÏö¥ ÏÇ¨ÏßÑ Ï¥¨ÏòÅ ÌõÑ Î™©Î°ùÏóê Ï∂îÍ∞Ä
    photoBtn?.addEventListener('click', async (e) => {
      e.preventDefault();
      if (photoBtn.disabled) return;
      photoBtn.disabled = true;

      try {
        const r = await fetch('/capture', { method: 'GET', cache: 'no-store' });
        const t = await r.text();
        if (t.trim().startsWith('cap')) {
          const id = parseInt(t.match(/\d+/)[0]);
          addPhotoToList(id);
        }
        if (t.trim() === 'done') triggerResultTransition();
      } catch (e) {
        console.error(e);
      } finally {
        photoBtn.disabled = false;
      }
    });

    // üìå ÏÉàÎ°ú Ï∂îÍ∞ÄÎêòÎäî Ïç∏ÎÑ§ÏùºÏóê ÎåÄÌï¥ toggle Îì±Î°ù
    function addPhotoToList(id) {
      const div = document.createElement('div');
      div.className = 'photo-thumb';
      div.dataset.id = id;
      div.innerHTML = `<img src="/static/capture${id}.jpg" alt="ÏÇ¨ÏßÑ ${id}" width="120" height="90">`;
      div.addEventListener('click', () => toggleSelect(div, id));
      photoList.appendChild(div);
    }

    // ‚úÖ Í≥µÌÜµ ÏÑ†ÌÉù toggle Ìï®Ïàò: ÏÑ†ÌÉù/ÏÑ†ÌÉùÏ∑®ÏÜå + ÏÑúÎ≤Ñ ÏöîÏ≤≠ + ÌÅ¥ÎûòÏä§ Ï≤òÎ¶¨
    function toggleSelect(el, id) {
      const isSelected = selected.has(id);
      const url = isSelected ? `/delete/${id}` : `/select/${id}`;
      fetch(url, { method: 'POST' }).then(r => {
        if (r.ok) {
          if (isSelected) {
            selected.delete(id);
            el.classList.remove('selected');
          } else {
            selected.add(id);
            el.classList.add('selected');
          }
        }
      });
    }
  });
</script>